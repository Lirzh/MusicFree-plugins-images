# 插件自动更新功能说明

本项目已配置 GitHub Actions 工作流，用于每日自动从每个插件的 `srcUrl` 地址更新所有 JS 插件。

## 功能介绍

- **全插件更新**：自动检测并更新目录下所有 JS 插件文件
- **智能源更新**：从每个插件自身定义的 `srcUrl` 地址获取最新版本
- **版本号管理**：自动递增每个插件的补丁版本号
- **同步配置**：同时更新 `plugins.json` 中的对应版本信息
- **定时执行**：每天 UTC 时间 0 点（北京时间 8 点）自动运行
- **手动触发**：支持通过 GitHub 界面手动触发更新
- **错误处理**：包含请求重试、错误日志记录等机制
- **自动提交**：有变更时自动提交并推送至仓库

## 工作原理

GitHub Actions 工作流文件位于 `.github/workflows/update-all-plugins.yml`，其更新流程如下：

1. **检出代码仓库**：获取当前最新代码
2. **设置 Node.js 环境**：配置运行环境
3. **安装必要依赖**：安装 axios 等工具包
4. **创建更新脚本**：生成用于更新插件的 JavaScript 脚本
5. **执行更新逻辑**：运行脚本执行实际的更新操作
6. **配置 Git 身份**：设置自动提交的用户信息
7. **检查变更**：确认是否有文件被修改
8. **提交推送**：如有变更，自动提交并推送到仓库

## 更新脚本核心逻辑

生成的 `update-all-plugins.js` 脚本会执行以下操作：

1. **遍历插件文件**：查找目录下所有 JS 插件文件
2. **提取源地址**：从每个插件文件中读取 `srcUrl` 字段
3. **下载最新内容**：通过 `srcUrl` 获取插件的最新版本
4. **版本号管理**：提取当前版本号并自动递增
5. **内容更新**：将最新内容写入本地文件并更新版本号
6. **配置同步**：更新 `plugins.json` 中的对应插件版本
7. **统计报告**：输出更新结果统计信息

## 使用前配置

在使用此自动更新功能前，需要在 GitHub 仓库中设置以下内容：

### 1. 添加 Personal Access Token

需要在仓库的 Secrets 中添加名为 `PERSONAL_TOKEN` 的个人访问令牌，该令牌需要有以下权限：
- `repo` - 完全控制私有仓库

设置步骤：
1. 前往 GitHub 个人设置 → Developer settings → Personal access tokens
2. 生成新令牌，选择所需权限
3. 在仓库的 Settings → Secrets and variables → Actions 中添加该令牌

### 2. 确认插件结构

确保所有插件文件都符合以下要求：
- 包含 `module.exports` 导出语句
- 在导出对象中包含 `srcUrl` 字段，指向插件的源地址
- 在导出对象中包含 `platform` 字段，定义插件名称
- 在导出对象中包含 `version` 字段，定义当前版本号

## 手动触发更新

除了定时运行外，还可以通过以下方式手动触发更新：

1. 进入 GitHub 仓库页面
2. 点击 "Actions" 选项卡
3. 选择 "每日更新所有插件" 工作流
4. 点击 "Run workflow" 按钮

## 错误处理机制

自动更新流程包含多层错误处理机制：

- **请求重试**：网络请求失败时自动重试（最多 3 次）
- **超时控制**：设置请求超时时间，防止长时间等待
- **错误日志**：详细记录每个插件的更新状态和错误信息
- **部分失败容忍**：单个插件更新失败不会影响其他插件的更新

## 注意事项

1. 请确保每个插件文件都正确设置了 `srcUrl`、`platform` 和 `version` 字段
2. `srcUrl` 指向的源地址必须是可公开访问的
3. 如需修改更新时间，请调整 workflow 文件中的 cron 表达式
4. 如遇到更新失败，请检查 GitHub Actions 日志获取详细错误信息
5. 自动更新会覆盖本地插件文件的内容，请确保重要修改已合并到源地址

## 自定义配置

如需自定义更新行为，可以修改 `.github/workflows/update-all-plugins.yml` 文件中的以下部分：

- **更新时间**：修改 `cron` 表达式以调整执行频率
- **Node.js 版本**：调整 `node-version` 值以使用不同的运行环境
- **重试次数**：在脚本中修改 `retries` 参数以调整请求重试次数
- **超时时间**：在脚本中修改 `timeout` 参数以调整请求超时时间

## 示例插件结构

一个标准的插件文件应包含以下关键信息：

```javascript
module.exports = {
    platform: "插件名称",  // 与 plugins.json 中的 name 对应
    version: "0.1.0",     // 当前版本号
    srcUrl: "https://example.com/path/to/plugin.js", // 插件源地址
    // 其他插件配置和功能...
};
```

## 更新日志

每次自动更新后，GitHub Actions 会生成详细的更新日志，包括：
- 成功更新的插件数量
- 失败更新的插件数量
- 每个插件的更新状态
- 任何错误的详细信息

这些日志可以在 GitHub Actions 的工作流运行页面查看。